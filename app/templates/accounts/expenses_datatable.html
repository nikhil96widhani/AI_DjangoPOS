{% extends 'base.html' %}
{% load static %}

{% block css %}
    {#    <link rel="stylesheet" type="text/css"#}
    {#          href="https://cdn.datatables.net/v/bs4/jszip-2.5.0/dt-1.10.22/b-1.6.5/b-colvis-1.6.5/b-flash-1.6.5/b-html5-1.6.5/b-print-1.6.5/fc-3.3.1/fh-3.1.7/kt-2.5.3/sc-2.0.3/sb-1.0.0/sp-1.2.1/sl-1.3.1/datatables.min.css"/>#}
    <link rel="stylesheet" type="text/css" href="{% static 'css/datatables.min.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/fm.tagator.jquery.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/jquery.autocomplete.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/daterangepicker.css' %}">
{% endblock %}

{% block page-title %}
    Expenses Datatable
{% endblock %}

{% block content %}
    <div class="card">
        <div class="card-body">
            <div class="row justify-content-between mt-1 mb-4">
                <div class="col-4">
                    <h2 class="pt-2">Expenses</h2>
                </div>
                <div class="col-4">
                    <button class="float-right btn btn btn-md btn-primary btn-rounded waves-effect waves-light"
                            data-toggle="modal" data-target="#expenseModal"><i class="fas fa-plus mr-2"></i>
                        Add Expenses
                    </button>
                </div>

        </div>
            <div class="form-inline float-left">
            <div id="reportrange" style="background: #fff; cursor: pointer;" class="">
                <i class="fa fa-calendar"></i>&nbsp;
                <span></span> <i class="fa fa-caret-down"></i>  |  <strong>Total Expenses:</strong> {{ my_config.currency }}<span id="total-amount">0.00</span>
            </div>
        </div>
            <table id="expenses-datatable" class="table nowrap text-center custom-datatable" style="width:100%">
                <thead>
                <tr class="" style="background: #e2e6ea">
                    <th>Title</th>
                    <th>Amount</th>
                    <th>Date</th>
                    <th>Expense For</th>
                    <th>Description</th>
                    <th>Receipt</th>
                    <th>Actions</th>
                </tr>
                </thead>
            </table>
        </div>
    </div>


    <!-- Modal -->
   <!-- Your HTML code for the modal form -->
<div class="modal fade" id="expenseModal" data-backdrop="static" data-keyboard="false" tabindex="-1" aria-labelledby="expenseModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="expenseModalLabel">Expense Details</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="expenseForm">
                    {% csrf_token %}
                    <input type="hidden" id="expenseId">

                    <div class="form-group">
                        <label for="expenseTitle" class="font-weight-bold">Title *</label>
                        <input type="text" class="form-control" id="expenseTitle" name="title" required>
                        <div class="invalid-feedback" style="display: none;">Please enter a title.</div>
                    </div>

                    <div class="form-group">
                        <label for="expenseAmount" class="font-weight-bold">Amount *</label>
                        <input type="number" class="form-control" id="expenseAmount" name="amount" step="0.01" required>
                        <div class="invalid-feedback" style="display: none;">Please enter an amount.</div>
                    </div>

                    <div class="form-group">
                        <label for="expenseDate" class="font-weight-bold">Date *</label>
                        <input type="date" class="form-control" id="expenseDate" name="date" required>
                        <div class="invalid-feedback" style="display: none;">Please select a date.</div>
                    </div>

                    <div class="form-group">
                        <label for="expenseFor">Expense For</label>
                        <input type="text" class="form-control" id="expenseFor" name="expense_for">
                        <div class="invalid-feedback"></div>
                    </div>

                    <div class="form-group">
                        <label for="expenseDescription">Description</label>
                        <textarea class="form-control" id="expenseDescription" name="description" rows="3"></textarea>
                        <div class="invalid-feedback"></div>
                    </div>

                    <!-- Add the Invoice field here -->
                    <div class="form-group">
                        <label for="expenseInvoice">Invoice</label>
                        <div class="custom-file">
                            <input type="file" class="custom-file-input" id="expenseInvoice" name="invoice">
                            <label class="custom-file-label" for="expenseInvoice">Choose file</label>
                        </div>
                        <div class="invalid-feedback"></div>
                    </div>

                              </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="validateAndSaveExpense()">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Confirm Delete Modal -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmDeleteModalLabel">Confirm Delete</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this expense?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="deleteExpenseConfirmed()">Delete</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block javascript %}
        <script type="text/javascript" src="{% static 'js/moment.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/fm.tagator.jquery.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/jquery.autocomplete.js' %}"></script>
    <script src="{% static 'js/jquery.pos.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/datatables.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'scripts/datatable-common.js' %}"></script>
        <script type="text/javascript" src="{% static 'js/daterangepicker.min.js' %}"></script>
<script>
// Function to open the modal form for adding a new expense
function openAddExpenseModal() {
    // Clear the form fields
    document.getElementById("expenseForm").reset();
    // Set the modal title to indicate adding a new expense
    document.getElementById("expenseModalLabel").innerText = "Add New Expense";
    // Remove the expenseId field value (since it's a new expense)
    document.getElementById("expenseId").value = "";
    // Show the modal
    $("#expenseModal").modal("show");
}

// Function to save the new expense when the Save button is clicked in the modal
function saveExpense() {
    const formData = new FormData(document.getElementById("expenseForm"));
    const expenseId = document.getElementById("expenseId").value;

    // Determine the API endpoint URL based on whether it's a new expense or an update
    const apiUrl = expenseId ? `/api/expenses/${expenseId}/` : "/api/expenses/";
    const method = expenseId ? "PUT" : "POST";

    // Perform the API request to save the expense
    fetch(apiUrl, {
        method: method,
        headers: {
            'X-CSRFToken': csrftoken
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        // Refresh the datatable to show the updated data
        $("#expenses-datatable").DataTable().ajax.reload();
        // Close the modal
        $("#expenseModal").modal("hide");
    })
    .catch(error => {
        // Handle any error
        console.error("Error saving expense:", error);
    });
}
function validateAndSaveExpense() {
    const titleInput = document.getElementById("expenseTitle");
    const amountInput = document.getElementById("expenseAmount");
    const dateInput = document.getElementById("expenseDate");

    // Check if the required fields are filled
    if (!titleInput.value || !amountInput.value || !dateInput.value) {
        const invalidFeedbackElements = document.querySelectorAll(".invalid-feedback");
        invalidFeedbackElements.forEach(element => element.style.display = "none");

        if (!titleInput.value) {
            titleInput.nextElementSibling.style.display = "block";
        }

        if (!amountInput.value) {
            amountInput.nextElementSibling.style.display = "block";
        }

        if (!dateInput.value) {
            dateInput.nextElementSibling.style.display = "block";
        }

        return;
    }

    // If all required fields are filled, proceed with form submission
    saveExpense();
}
// Function to delete an expense when the Delete button is clicked
function deleteExpense(expenseId) {
    // Determine the API endpoint URL
    const apiUrl = `/api/expenses/${expenseId}/`;

    // Perform the API request to delete the expense
    fetch(apiUrl, {
        method: "DELETE",
        headers: {
            'X-CSRFToken': csrftoken
        },
    })
    .then(response => {
        if (response.ok) {
            // Refresh the datatable to show the updated data
            $("#expenses-datatable").DataTable().ajax.reload();
        } else {
            // Handle the case when the deletion request fails
            console.error("Error deleting expense:", response.statusText);
        }
    })
    .catch(error => {
        // Handle any other error
        console.error("Error deleting expense:", error);
    });
}

let expenseIdToDelete;

function showConfirmDeleteModal(expenseId) {
    expenseIdToDelete = expenseId;
    $('#confirmDeleteModal').modal('show');
}

function deleteExpenseConfirmed() {
    // Perform the deletion using the expenseIdToDelete
    deleteExpense(expenseIdToDelete)
    // After successful deletion, hide the modal
    $('#confirmDeleteModal').modal('hide');
}

// Function to open the modal form for editing an expense
function editExpense(expenseId) {
    // Determine the API endpoint URL for retrieving the expense details
    const apiUrl = `/api/expenses/${expenseId}/`;

    // Fetch the expense details from the backend
    fetch(apiUrl)
    .then(response => response.json())
    .then(data => {
        // Set the modal title to indicate editing the expense
        document.getElementById("expenseModalLabel").innerText = "Edit Expense";
        // Set the expenseId field value to the current expense's ID
        document.getElementById("expenseId").value = data.id;
        // Fill the form fields with the expense details
        document.getElementById("expenseTitle").value = data.title;
        document.getElementById("expenseAmount").value = data.amount;
        document.getElementById("expenseDate").value = data.date;
        document.getElementById("expenseFor").value = data.expense_for;
        document.getElementById("expenseDescription").value = data.description;
        // Show the modal
        $("#expenseModal").modal("show");
    })
    .catch(error => {
        // Handle any error
        console.error("Error fetching expense details:", error);
    });
}

// Allow only numbers with up to two decimal places in the "Amount" field
document.getElementById("expenseAmount").addEventListener("input", function (event) {
    const regex = /^\d+(\.\d{0,2})?$/;
    const inputText = event.target.value;

    if (!regex.test(inputText)) {
        event.target.value = inputText.slice(0, -1);
    }
});

// Add event listener to open the modal form when the "Add Expenses" button is clicked
document.querySelector('.btn-primary[data-target="#expenseModal"]').addEventListener('click', openAddExpenseModal);

$(document).ready(function () {
    $(function() {

    var start = moment().startOf('month')
    var end = moment().endOf('month')

    function cb(start, end) {
        $('#reportrange span').html(start.format('MMMM D, YYYY') + ' - ' + end.format('MMMM D, YYYY'));
        const startDate = start.format('YYYY-MM-DD');
        const endDate = end.format('YYYY-MM-DD');
        fetchExpensesData(startDate, endDate);
    }

    $('#reportrange').daterangepicker({
        startDate: start,
        endDate: end,
        ranges: {
           'Today': [moment(), moment()],
           'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
           'Last 7 Days': [moment().subtract(6, 'days'), moment()],
           'Last 30 Days': [moment().subtract(29, 'days'), moment()],
           'This Month': [moment().startOf('month'), moment().endOf('month')],
           'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
        }
    }, cb);

    cb(start, end);

});
    // Initialize the DataTable
    {#fetchExpensesData();#}
});
                            {#return data ? '<i class="fa-solid fa-arrow-up-right-from-square"></i><a href="' + data + '" target="_blank" class="text-primary"> View Invoice</a>' : 'N/A';#}

// Function to fetch expenses data based on the selected date range and update the DataTable
function fetchExpensesData(startDate, endDate) {
    let url = `/api/expenses/?format=datatables&start_date=${encodeURIComponent(startDate)}&end_date=${encodeURIComponent(endDate)}`;

    fetch(url)
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to fetch expenses data');
            }
            return response.json();
        })
        .then(data => {
                $("#expenses-datatable").DataTable({
                    destroy: true,
                processing: true,
                serverSide: false,
                 order: [[2, 'desc']],
                dom: '<"toolbar">frtip',
                ajax: {
                    url: url, // Change the URL to match your Django API endpoint for expenses
                    type: 'GET',
                    headers: {
                        'X-CSRFToken': csrftoken
                    },
                },
                columns: [
                    {data: 'title', 'width': '15%'},
                    {data: 'amount', 'width': '10%'},
                    {data: 'date', 'width': '10%'},
                    {data: 'expense_for', 'width': '15%' , render: function (data, type, row) {
                            return data ? data : 'N/A';
                        }},
                    {data: 'description',render: function (data, type, row) {
                            return data ? data : 'N/A';
                        }},
                    {
                        data: 'invoice', 'width': '10%',
                        render: function (data, type, row) {

                            return data ? '<i class="fa-solid fa-arrow-up-right-from-square"></i><a href="' + data + '" target="_blank" class="text-primary"> View Invoice</a>' : 'N/A';
                        }
                    },
                    {
                        data: null , 'width': '10%', render: function (data, type, row) {
                    return `
<a class="pr-3"><i class="fa fa-pen" aria-hidden="true" onclick="editExpense(${row.id})"></i></a>
                            <a class=""><i class="fa fa-trash" aria-hidden="true" onclick="showConfirmDeleteModal(${row.id})"></i></a></td>`;
                }},
                ],
                     "fnDrawCallback": function ( row, data, start, end, display ) {
                        var api = this.api(), data;

            // Remove the formatting to get integer data for summation
            var intVal = function ( i ) {
                return typeof i === 'string' ?
                    i.replace(/[\$,]/g, '')*1 :
                    typeof i === 'number' ?
                        i : 0;
            };

            // Total over all pages
            total = api
                .column( 1 )
                .data()
                .reduce( function (a, b) {
                    return intVal(a) + intVal(b);
                }, 0 );

            // Total over this page
            pageTotal = api
                .column( 1, { page: 'current'} )
                .data()
                .reduce( function (a, b) {
                    return intVal(a) + intVal(b);
                }, 0 );

            // Update status DIV
            $('#total-amount').html(total);
                     }
                // Add any other DataTable options as needed
            });

        })
        .catch(error => console.error('Error fetching expenses data:', error));
}
</script>
{% endblock %}
